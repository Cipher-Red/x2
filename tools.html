<!DOCTYPE html>
<html>
<head>
<title>X2</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Titillium+Web:wght@300&display=swap');
@import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css');

.fa-2x {
  font-size: 2em;
}

.fa {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 60px;
  height: 36px;
  font-size: 20px;
}

.main-menu {
  background: #73AF6F;
  border-right: 1px solid #e5e5e5;
  position: fixed;
  top: 0;
  left: 0;
  height: 100%;
  width: 60px;
  overflow: hidden;
  transition: width 0.2s ease-in-out;
  z-index: 1000;
}

.main-menu:hover,
.main-menu.expanded {
  width: 250px;
}

.main-menu > ul {
  margin: 7px 0;
  list-style: none;
  padding: 0;
}

.main-menu li {
  width: 250px;
}

.main-menu li > a {
  display: flex;
  align-items: center;
  color: white;
  font-family: Arial, sans-serif;
  font-size: 14px;
  text-decoration: none;
  transition: all 0.2s ease-in-out;
  padding: 8px 0;
}

.main-menu li:hover > a,
.main-menu li.active > a {
  color: #fff;
  background: #435663;
}

.main-menu .nav-icon {
  flex: 0 0 60px;
  text-align: center;
  font-size: 18px;
}

.main-menu .nav-text {
  flex: 1;
  font-family: 'Titillium Web', sans-serif;
}

.main-menu > ul.logout {
  position: absolute;
  bottom: 0;
  left: 0;
}

/* Price Match Styles */
.info-panel {
  background: rgba(255, 255, 255, 0.1);
  border: 2px solid #73AF6F;
  border-radius: 1rem;
  padding: 1.5rem;
  backdrop-filter: blur(15px);
  margin-bottom: 1.5rem;
}

.info-row {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  margin-bottom: 1rem;
}

.info-row label {
  font-size: 1.125rem;
  font-weight: 600;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.info-stat {
  font-size: 1rem;
  padding: 0.5rem 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.info-stat span:last-child {
  font-weight: 700;
  color: #73AF6F;
}

input[type="number"],
input[type="text"],
textarea {
  background: rgba(0, 0, 0, 0.3);
  color: white;
  border: 2px solid #73AF6F;
  border-radius: 0.5rem;
  padding: 0.75rem;
  font-size: 0.95rem;
  transition: all 0.3s ease;
  outline: none;
  width: 100%;
}

input[type="number"]:focus,
input[type="text"]:focus,
textarea:focus {
  border-color: #435663;
  box-shadow: 0 0 0 3px rgba(115, 175, 111, 0.2);
}

input[type="number"] {
  text-align: center;
}

textarea {
  resize: vertical;
  min-height: 6rem;
  font-family: inherit;
}

.button-group {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  margin-top: 1rem;
}

button {
  background: #73AF6F;
  color: white;
  border: none;
  border-radius: 2rem;
  padding: 0.65rem 1.5rem;
  font-weight: 600;
  font-size: 0.95rem;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
}

button:hover:not(:disabled) {
  background: #435663;
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(67, 86, 99, 0.4);
}

button:active:not(:disabled) {
  transform: translateY(0);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.parts-container {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  max-height: 600px;
  overflow-y: auto;
  padding-right: 0.5rem;
}

.parts-container::-webkit-scrollbar {
  width: 8px;
}

.parts-container::-webkit-scrollbar-track {
  background: rgba(115, 175, 111, 0.1);
  border-radius: 4px;
}

.parts-container::-webkit-scrollbar-thumb {
  background: #73AF6F;
  border-radius: 4px;
}

.parts-container::-webkit-scrollbar-thumb:hover {
  background: #435663;
}

.part-row {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid #73AF6F;
  border-radius: 0.5rem;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.part-row:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: #435663;
}

.part-row input[type="number"],
.part-row input[type="text"] {
  margin: 0;
  height: 2.5rem;
}

.part-row input:nth-child(1) { width: 4rem; }
.part-row input:nth-child(2) { flex: 1; min-width: 150px; }
.part-row input:nth-child(3) { width: 8rem; }
.part-row input:nth-child(4) { width: 5.5rem; }
.part-row input:nth-child(5) { width: 5.5rem; background: rgba(115, 175, 111, 0.1); }

.refund-checkbox {
  appearance: none;
  height: 1.75rem;
  width: 1.75rem;
  border: 2px solid #73AF6F;
  border-radius: 0.375rem;
  cursor: pointer;
  position: relative;
  transition: all 0.3s ease;
  flex-shrink: 0;
}

.refund-checkbox:hover {
  border-color: #435663;
  box-shadow: 0 0 8px rgba(115, 175, 111, 0.5);
}

.refund-checkbox:checked {
  background-color: #73AF6F;
  box-shadow: 0 0 12px rgba(115, 175, 111, 0.7);
}

.refund-checkbox:checked::after {
  content: '✓';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-size: 1.25rem;
  font-weight: bold;
}

.error-message {
  color: #ff6b6b;
  font-size: 0.875rem;
  margin-top: 0.5rem;
  padding: 0.5rem;
  background: rgba(255, 107, 107, 0.1);
  border-radius: 0.375rem;
  border-left: 3px solid #ff6b6b;
}

.status-message {
  font-size: 1rem;
  padding: 0.75rem;
  margin-top: 0.5rem;
  border-radius: 0.5rem;
  font-weight: 600;
  text-align: center;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

</head>

<body style="background-image: linear-gradient(90.2deg, #73AF6F -0.4%, #435663 106.1%); color:white; font-family: Trebuchet MS,Lucida Grande,Lucida Sans Unicode,Lucida Sans,Tahoma,sans-serif;">

<div class="area"></div>
<nav class="main-menu">
  <div class="nav-logo" style="text-align:center; padding: 20px 0;">
    <a href="Index.html" style="color:inherit">
      <i class="fa fa-superscript" aria-hidden="true"></i>
    </a>
  </div>

  <ul>
    <li>
      <a href="Index.html">
        <i class="fa fa-home" aria-hidden="true"></i>
        <span class="nav-text">Home</span>
      </a>
    </li>
    <li class="has-subnav">
      <a href="tools.html">
        <i class="fa fa-cube" aria-hidden="true"></i>
        <span class="nav-text">Tasks & Tools</span>
      </a>
    </li>
    <li class="has-subnav">
      <a href="#">
        <i class="fa fa-database" aria-hidden="true"></i>
        <span class="nav-text">DataBase</span>
      </a>
    </li>
    <li class="has-subnav">
      <a href="#">
        <i class="fa fa-circle-o-notch" aria-hidden="true"></i>
        <span class="nav-text">Setting</span>
      </a>
    </li>
  </ul>
</nav>

<H2 style="border-bottom:solid 1px; padding-left:250px;">Tasks & Tools</h2>

<div id="priceMatchCalculator"></div>

<script>
(function() {
  'use strict';

  // ============================================================================
  // STATE MANAGEMENT
  // ============================================================================
  const State = {
    kitPrice: 0,
    partPrices: [],

    setKitPrice(price) {
      this.kitPrice = parseFloat(price) || 0;
    },

    addPart() {
      this.partPrices.push(0);
    },

    removePart() {
      this.partPrices.pop();
    },

    updatePartPrice(index, price) {
      if (index >= 0 && index < this.partPrices.length) {
        this.partPrices[index] = parseFloat(price) || 0;
      }
    },

    clearAll() {
      this.kitPrice = 0;
      this.partPrices = [];
    },

    getTotalPrice() {
      return this.partPrices.reduce((sum, price) => sum + price, 0);
    }
  };

  // ============================================================================
  // CALCULATOR
  // ============================================================================
  const Calculator = {
    calculateRatio() {
      const totalPrice = State.getTotalPrice();
      return totalPrice > 0 && State.kitPrice > 0 ? State.kitPrice / totalPrice : 0;
    },

    calculateRefundForPart(partPrice) {
      return partPrice * this.calculateRatio();
    },

    calculateTotals(selectedIndices) {
      let refundTotal = 0;
      selectedIndices.forEach(index => {
        if (index < State.partPrices.length) {
          refundTotal += this.calculateRefundForPart(State.partPrices[index]);
        }
      });
      return {
        refund: refundTotal,
        deduction: Math.max(0, State.kitPrice - refundTotal)
      };
    }
  };

  // ============================================================================
  // PART PARSER
  // ============================================================================
  const PartParser = {
    isPadPart(partName) {
      if (!partName) return false;
      const lowerName = partName.toLowerCase();
      const padKeywords = [
        'brake pad', 'brake pads', 'front pad', 'rear pad',
        'ceramic pad', 'metallic pad', 'semi-metallic pad',
        'organic pad', 'disc pad', 'drum pad', 'pad set'
      ];
      return padKeywords.some(keyword => lowerName.includes(keyword));
    },

    parseBulkText(text) {
      if (!text || !text.trim()) return [];
      
      const lines = text.trim().split('\n');
      const parts = [];
      
      lines.forEach(line => {
        line = line.trim();
        if (!line) return;
        
        // Try to extract quantity from the beginning
        const qtyMatch = line.match(/^(\d+)\s*(.+)$/);
        let qty = 1;
        let rest = line;
        
        if (qtyMatch) {
          qty = parseInt(qtyMatch[1]);
          rest = qtyMatch[2];
        }
        
        // Split by common delimiters to find part number at the end
        const segments = rest.split(/[\t|]/);
        
        let partName = '';
        let partNumber = '';
        
        if (segments.length >= 2) {
          // Last segment is likely the part number
          partNumber = segments[segments.length - 1].trim();
          // Everything before that is the part name
          partName = segments.slice(0, -1).join(' ').trim();
        } else {
          // Try to find part number pattern (alphanumeric with dashes)
          const partNumMatch = rest.match(/([A-Z]{2,}\d+[A-Z0-9\-]*)\s*$/i);
          if (partNumMatch) {
            partNumber = partNumMatch[1];
            partName = rest.substring(0, partNumMatch.index).trim();
          } else {
            partName = rest;
          }
        }
        
        // If it's a pad part, force quantity to 1
        if (this.isPadPart(partName)) {
          qty = 1;
        }
        
        if (partName || partNumber) {
          parts.push({
            qty: qty,
            name: partName,
            partNumber: partNumber
          });
        }
      });
      
      return parts;
    }
  };

  // ============================================================================
  // UI For the Price Match thing
  // ============================================================================
  const UI = {
    container: null,

    init() {
      this.container = document.getElementById('priceMatchCalculator');
      this.render();
    },

    render() {
      this.container.innerHTML = `
        <div style="font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; border: 2px solid #333; border-radius: 8px; background: #435663">
          <h2 style="text-align: center; margin-bottom: 20px;">Price Match</h2>
          
          <div style="margin-bottom: 20px; padding: 15px; background: #435663; border-radius: 5px;">
            <center><label style="display: block; margin-bottom: 8px; font-weight: bold;">|Kit Price|</label>
            <center><input type="number" id="kitPriceInput" min="0" step="0.01" placeholder="0.00" 
                   style="width: 90%; padding: 20px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px;">
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div style="padding: 15px; background: #435663; border-radius: 5px; text-align: center;">
              <div style="font-size: 12px; margin-bottom: 5px;">Refund Amount</div>
              <div style="font-size: 24px; font-weight: bold; color: #2e7d32;">$<span id="refundTotal">0.00</span></div>
            </div>
            <div style="padding: 15px; background: #435663; border-radius: 5px; text-align: center;">
              <div style="font-size: 12px; margin-bottom: 5px;">Deduction Amount</div>
              <div style="font-size: 24px; font-weight: bold; color: #e65100;">$<span id="deductionTotal">0.00</span></div>
            </div>
          </div>

          <div style="margin-bottom: 20px; padding: 15px; background: #435663; border-radius: 5px;">
            <label style="display: block; margin-bottom: 8px; font-weight: bold;">Bulk Add Parts:</label>
            <textarea id="bulkInput" placeholder="Paste parts here (one per line)&#10;Example:&#10;1 Rack and Pinion Tie Rod Boots (Pair) BT-201x2&#10;2 Front Driver or Passenger Side Outer Tie Rod ES2814&#10;1 Front Brake Pads ABC123" 
                      style="width: 100%; min-height: 100px; padding: 8px; font-size: 13px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; resize: vertical;"></textarea>
            <button id="bulkAddBtn" style="margin-top: 10px; padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Process Bulk Parts</button>
            <div id="bulkStatus" style="margin-top: 10px; padding: 8px; border-radius: 4px; display: none;"></div>
          </div>

          <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <button id="addPartBtn" style="padding: 10px 20px; background: #435663; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Add Part</button>
            <button id="removePartBtn" style="padding: 10px 20px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Remove Part</button>
            <button id="clearBtn" style="padding: 10px 20px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Clear All</button>
          </div>

          <div id="partsContainer" style="max-height: 500px; overflow-y: auto;"></div>

          <div id="emailSection" style="display: none; margin-top: 20px; padding: 15px; background: #435663; border-radius: 5px;">
            <h3 style="margin-bottom: 10px; color: white;">Email Template</h3>
            <textarea id="emailTemplate" style="width: 100%; min-height: 150px; padding: 8px; font-size: 13px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; resize: vertical; background: rgba(0,0,0,0.3); color: white;"></textarea>
            <div style="margin-top: 10px;">
              <button id="saveTemplateBtn" style="padding: 8px 16px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Save Template</button>
              <button id="sendEmailBtn" style="padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer;">Send Email</button>
            </div>
          </div>

          <div id="notesLog" style="margin-top: 20px; padding: 15px; background: #435663; border-radius: 5px;"></div>
        </div>
      `;

      this.attachEvents();
      this.addPartRow();
    },

    attachEvents() {
      document.getElementById('kitPriceInput').addEventListener('input', (e) => {
        State.setKitPrice(e.target.value);
        this.updateTotals();
      });

      document.getElementById('addPartBtn').addEventListener('click', () => this.addPartRow());
      document.getElementById('removePartBtn').addEventListener('click', () => this.removePartRow());
      document.getElementById('clearBtn').addEventListener('click', () => this.clearAll());
      document.getElementById('bulkAddBtn').addEventListener('click', () => this.processBulkParts());

      // Email events
      document.getElementById('saveTemplateBtn').addEventListener('click', () => {
        const templateText = document.getElementById('emailTemplate').value;
        localStorage.setItem('savedPriceMatchTemplate', templateText);
        alert('Template saved to localStorage!');
      });

      document.getElementById('sendEmailBtn').addEventListener('click', () => {
        this.simulateSend();
      });
    },

    processBulkParts() {
      const bulkInput = document.getElementById('bulkInput');
      const bulkStatus = document.getElementById('bulkStatus');
      const text = bulkInput.value;

      if (!text.trim()) {
        bulkStatus.style.display = 'block';
        bulkStatus.style.background = '#ffebee';
        bulkStatus.style.color = '#c62828';
        bulkStatus.textContent = '⚠ Please paste some parts first';
        setTimeout(() => bulkStatus.style.display = 'none', 3000);
        return;
      }

      const parts = PartParser.parseBulkText(text);

      if (parts.length === 0) {
        bulkStatus.style.display = 'block';
        bulkStatus.style.background = '#ffebee';
        bulkStatus.style.color = '#c62828';
        bulkStatus.textContent = '⚠ No valid parts found';
        setTimeout(() => bulkStatus.style.display = 'none', 3000);
        return;
      }

      // Clear existing parts
      const container = document.getElementById('partsContainer');
      container.innerHTML = '';
      State.partPrices = [];

      // Add all parsed parts
      parts.forEach(part => {
        this.addPartRow(part.qty, part.name, part.partNumber);
      });

      // Clear bulk input and show success message
      bulkInput.value = '';
      bulkStatus.style.display = 'block';
      bulkStatus.style.background = '#e8f5e9';
      bulkStatus.style.color = '#2e7d32';
      bulkStatus.textContent = `✓ Successfully added ${parts.length} part${parts.length !== 1 ? 's' : ''}`;
      setTimeout(() => bulkStatus.style.display = 'none', 3000);
    },

    addPartRow(qty = 1, partName = '', partNumber = '') {
      State.addPart();
      const index = State.partPrices.length - 1;
      const container = document.getElementById('partsContainer');
      
      const isPad = PartParser.isPadPart(partName);
      if (isPad) qty = 1;
      
      const row = document.createElement('div');
      row.style.cssText = 'display: grid; grid-template-columns: 70px 1fr 100px 90px 90px 35px; gap: 8px; padding: 10px; margin-bottom: 8px; background: #435663; border: 1px solid #ddd; border-radius: 4px; align-items: center;';
      row.dataset.index = index;
      
      const qtyStyle = isPad 
        ? 'width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 3px; text-align: center; background: #ffe0b2;'
        : 'width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 3px; text-align: center;';
      
      row.innerHTML = `
        <input type="number" min="1" value="${qty}" placeholder="Qty" class="qtyInput" style="${qtyStyle}" ${isPad ? 'readonly title="Pad detected - Quantity locked to 1"' : ''}>
        <input type="text" placeholder="Part Name" value="${partName}" class="partNameInput" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 3px; text-align: center;">
        <input type="text" placeholder="Part #" value="${partNumber}" class="partNumberInput" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 3px; text-align: center;">
        <input type="number" min="0" step="0.01" placeholder="Price" class="priceInput" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 3px text-align: center;">
        <input type="text" readonly class="refundDisplay" value="0.00" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 3px; background: #e0e0e0; text-align: center;">
        <input type="checkbox" class="checkbox" style="width: 20px; height: 20px; cursor: pointer;">
      `;

      container.appendChild(row);

      row.querySelector('.qtyInput').addEventListener('input', () => this.updateTotals());
      row.querySelector('.priceInput').addEventListener('input', () => this.updateTotals());
      row.querySelector('.checkbox').addEventListener('change', () => this.updateTotals());
      
      // Monitor part name changes to detect pads
      row.querySelector('.partNameInput').addEventListener('input', (e) => {
        const qtyInput = row.querySelector('.qtyInput');
        if (PartParser.isPadPart(e.target.value)) {
          qtyInput.value = 1;
          qtyInput.readOnly = true;
          qtyInput.style.background = '#ffe0b2';
          qtyInput.title = 'Pad detected - Quantity locked to 1';
        } else {
          qtyInput.readOnly = false;
          qtyInput.style.background = '#fff';
          qtyInput.title = '';
        }
        this.updateTotals();
      });
    },

    removePartRow() {
      const container = document.getElementById('partsContainer');
      if (State.partPrices.length > 0) {
        State.removePart();
        container.removeChild(container.lastChild);
        this.updateTotals();
      }
    },

    clearAll() {
      State.clearAll();
      document.getElementById('kitPriceInput').value = '';
      document.getElementById('bulkInput').value = '';
      document.getElementById('partsContainer').innerHTML = '';
      document.getElementById('emailSection').style.display = 'none';
      document.getElementById('notesLog').innerHTML = '';
      this.updateTotals();
    },

    generateEmailTemplate(totals, selectedIndices) {
      const rows = document.querySelectorAll('#partsContainer [data-index]');
      let partsList = '';
      selectedIndices.forEach(idx => {
        const row = rows[idx];
        const qty = parseFloat(row.querySelector('.qtyInput').value) || 1;
        const name = row.querySelector('.partNameInput').value || 'Unnamed Part';
        const partNumber = row.querySelector('.partNumberInput').value || '';
        partsList += `• ${qty} x ${name}`;
        if (partNumber) partsList += ` (SKU: ${partNumber})`;
        partsList += '\n';
      });
      if (!partsList.trim()) partsList = 'No parts selected.';
      const template = `Subject: Confirmation of Price Match Refund

Dear Valued Customer,

We hope this email finds you well.

We are happy to confirm that your price match request has been processed successfully.

**Refund Amount:** $${totals.refund.toFixed(2)}

**Deduction Amount:** $${totals.deduction.toFixed(2)}

The refund applies to the following parts in your kit:

${partsList}

Please allow 3-5 business days for the refund to process to your original payment method.

If you have any questions or need further assistance, feel free to reply to this email.

Thank you for choosing us!

Best regards,  
Johnson  
Customer Service Agent  
[Company Name]  
support@company.com`;
      document.getElementById('emailTemplate').value = template;
    },

    simulateSend() {
      const rows = document.querySelectorAll('#partsContainer [data-index]');
      let refundTotal = 0;
      let skus = [];
      rows.forEach((row, index) => {
        const checkbox = row.querySelector('.checkbox');
        if (checkbox.checked) {
          const partNumber = row.querySelector('.partNumberInput').value.trim();
          if (partNumber) skus.push(partNumber);
          const qty = parseFloat(row.querySelector('.qtyInput').value) || 1;
          const price = parseFloat(row.querySelector('.priceInput').value) || 0;
          const lineTotal = qty * price;
          refundTotal += Calculator.calculateRefundForPart(lineTotal);
        }
      });
      const refundAmt = refundTotal.toFixed(2);
      const skusStr = skus.length > 0 ? skus.join(', ') : 'N/A';
      const now = new Date();
      const month = (now.getMonth() + 1).toString().padStart(2, '0');
      const day = now.getDate().toString().padStart(2, '0');
      const dateStr = `${month}/${day}`;
      const note = `${dateStr} Follow Up - parts are in a good condition(${skusStr}) , refund form submitted ($${refundAmt}) , Email sent , Johnson`;
      const notesLog = document.getElementById('notesLog');
      let logContent = notesLog.innerHTML;
      if (!logContent.trim()) {
        logContent = '<h4 style="margin-top: 0; color: white;">Activity Log:</h4>';
      }
      notesLog.innerHTML = logContent + `<div class="status-message" style="background: #e8f5e9; color: #2e7d32; margin-bottom: 10px;">${note}</div>`;
      alert('Email sent successfully! Note added to log.');
    },

    updateTotals() {
      const rows = document.getElementById('partsContainer').querySelectorAll('[data-index]');
      const selectedIndices = [];

      rows.forEach((row, index) => {
        const qty = parseFloat(row.querySelector('.qtyInput').value) || 1;
        const price = parseFloat(row.querySelector('.priceInput').value) || 0;
        const lineTotal = qty * price;

        State.updatePartPrice(index, lineTotal);

        const refund = Calculator.calculateRefundForPart(lineTotal);
        row.querySelector('.refundDisplay').value = refund.toFixed(2);

        if (row.querySelector('.checkbox').checked) {
          selectedIndices.push(index);
        }
      });

      const totals = Calculator.calculateTotals(selectedIndices);
      document.getElementById('refundTotal').textContent = totals.refund.toFixed(2);
      document.getElementById('deductionTotal').textContent = totals.deduction.toFixed(2);

      const emailSection = document.getElementById('emailSection');
      if (emailSection) {
        if (totals.refund > 0) {
          emailSection.style.display = 'block';
          this.generateEmailTemplate(totals, selectedIndices);
        } else {
          emailSection.style.display = 'none';
        }
      }
    }
  };

  // ============================================================================
  // INITIALIZE
  // ============================================================================
  UI.init();
})();
</script>
  

</body>
</html>